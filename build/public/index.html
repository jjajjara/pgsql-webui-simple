<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL WebUI Simple</title>
    <style>
        /* --- Base Styles Reset --- */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; -moz-tab-size: 4; tab-size: 4; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
        body { margin: 0; line-height: inherit; background-color: #111827; color: #d1d5db; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        h1, h2, h3, h4, h5, h6, p, nav, button, input, form { margin: 0; padding: 0; font-family: inherit; font-size: 100%; }
        button { background-color: transparent; background-image: none; cursor: pointer; }
        table { text-indent: 0; border-color: inherit; border-collapse: collapse; }
        a { color: inherit; text-decoration: inherit; }
        /* --- End Base Styles --- */

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Layout */
        .h-screen { height: 100vh; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1 1 0%; }
        .flex-shrink-0 { flex-shrink: 0; }
        .flex-grow { flex-grow: 1; }
        .w-64 { width: 16rem; }
        .w-full { width: 100%; }
        .w-32 { width: 8rem; }
        .max-w-2xl { max-width: 42rem; }
        /* Spacing */
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2\.5 { padding-top: 0.625rem; padding-bottom: 0.625rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .py-16 { padding-top: 4rem; padding-bottom: 4rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-8 { margin-top: 2rem; }
        .mt-auto { margin-top: auto; }
        .ml-4 { margin-left: 1rem; }
        .ml-2 { margin-left: 0.5rem; }
        .w-4 { width: 1rem; }
        /* Typography */
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .text-white { color: #fff; }
        .text-gray-100 { color: #f3f4f6; }
        .text-gray-200 { color: #e5e7eb; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-indigo-400 { color: #818cf8; }
        .text-red-400 { color: #f87171; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Background */
        .bg-gray-900 { background-color: #111827; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-black { background-color: #000; }
        .bg-opacity-70 { background-color: rgba(0, 0, 0, 0.7); }
        .bg-opacity-50 { background-color: rgba(0, 0, 0, 0.5); }
        /* Border */
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .border { border-width: 1px; }
        .border-gray-700 { border-color: #374151; }
        .border-gray-600 { border-color: #4b5563; }
        /* Effects */
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .transition { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-150 { transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        .duration-300 { transition-duration: 300ms; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:text-white:hover { color: #fff; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:text-indigo-600:hover { color: #4f46e5; }
        .hover\:text-red-600:hover { color: #dc2626; }
        .hover\:text-gray-300:hover { color: #d1d5db; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:ring-2:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
        /* Other */
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .hidden { display: none; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .bottom-5 { bottom: 1.25rem; }
        .right-5 { right: 1.25rem; }
        .z-50 { z-index: 50; }
        .inline-block { display: inline-block; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-right: 0; margin-left: 1rem; }
        .min-w-full { min-width: 100%; }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 1px; }
        .divide-gray-700 > :not([hidden]) ~ :not([hidden]) { border-color: #374151; }
        .divide-gray-600 > :not([hidden]) ~ :not([hidden]) { border-color: #4b5563; }
        .whitespace-nowrap { white-space: nowrap; }
        .relative { position: relative; }
        .transform { transform: translateX(0) translateY(0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .table-fixed { table-layout: fixed; }
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-leave { opacity: 1; transform: scale(1); }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
        /* Loader Animation */
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .opacity-0 { opacity: 0; }
        .opacity-25 { opacity: 0.25; }
        .opacity-75 { opacity: 0.75; }
        .opacity-100 { opacity: 1; }
        .translate-y-0 { transform: translateY(0); }
        .translate-y-2 { transform: translateY(0.5rem); }

        #table-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem; 
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

<div id="app" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-6 flex-shrink-0 overflow-y-auto flex flex-col">
        <h1 class="text-2xl font-bold text-white mb-8">
            <svg class="inline-block mr-2" viewBox="0 0 24 24" fill="currentColor" style="width: 2rem; height: 2rem; vertical-align: middle;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h-2zm0 6h2v2h-2z"/>
            </svg>
            DB Admin
        </h1>
        <nav id="table-list" class="flex-grow">
            <p class="text-gray-400">Loading tables...</p>
        </nav>
        <div class="mt-auto text-center text-xs text-gray-500">
            <p>Created by jjajjara</p>
            <p class="mt-1">
                <a href="https://hub.docker.com/r/jjajjara/pgsql-webui-simple" target="_blank" class="hover:text-gray-300">
                    Docker Hub Image
                </a>
            </p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto">
        <header class="flex justify-between items-center mb-6">
            <h2 id="current-table-name" class="text-3xl font-bold text-white">Select a table</h2>
            <div class="flex items-center space-x-4">
                <button id="reset-sort-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center">
                    <svg class="mr-2" style="width: 1.25rem; height: 1.25rem;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    Reset Sort
                </button>
                <button id="create-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center">
                    <svg class="mr-2" viewBox="0 0 20 20" fill="currentColor" style="width: 1.25rem; height: 1.25rem;"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Create New
                </button>
            </div>
        </header>
        <div id="content-area" class="bg-gray-800 rounded-lg shadow-lg p-6">
             <div id="placeholder" class="text-center text-gray-400 py-16">
                 <p>Please select a table from the sidebar.</p>
             </div>
             <div id="data-table-container" class="hidden overflow-x-auto"></div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden modal-enter">
    <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-2xl border border-gray-700 transform">
        <h3 id="modal-title" class="text-2xl font-bold mb-6 text-white"></h3>
        <form id="modal-form"></form>
        <div class="flex justify-end space-x-4 mt-8">
            <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">Cancel</button>
            <button id="modal-submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">Save</button>
        </div>
    </div>
</div>

<!-- Notification Toast -->
<div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-2 transition-all duration-300">
    <p id="toast-message"></p>
</div>

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <svg class="animate-spin" fill="none" viewBox="0 0 24 24" style="width: 2.5rem; height: 2.5rem; color: white;">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = '/api';

    const tableList = document.getElementById('table-list');
    const currentTableNameEl = document.getElementById('current-table-name');
    const createBtn = document.getElementById('create-btn');
    const resetSortBtn = document.getElementById('reset-sort-btn');
    const placeholder = document.getElementById('placeholder');
    const dataTableContainer = document.getElementById('data-table-container');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalForm = document.getElementById('modal-form');
    const modalCancel = document.getElementById('modal-cancel');
    const modalSubmit = document.getElementById('modal-submit');

    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    const loader = document.getElementById('loader');

    let state = {
        tables: [],
        schemas: {},
        currentTable: null,
        currentData: [],
        editingItem: null,
        sorting: { 
            column: null,
            direction: 'asc'
        }
    };

    const showLoader = () => loader.classList.remove('hidden');
    const hideLoader = () => loader.classList.add('hidden');

    const showToast = (message, isError = false) => {
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0`;
        setTimeout(() => {
            toast.className = toast.className.replace('opacity-100 translate-y-0', 'opacity-0 translate-y-2');
        }, 3000);
    };

    async function apiFetch(url, options = {}) {
        showLoader();
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }
            if (response.status === 204) {
                return null;
            }
            return response.json();
        } catch (error) {
            console.error('API Fetch Error:', error);
            showToast(error.message, true);
            throw error;
        } finally {
            hideLoader();
        }
    }

    function renderTableList() {
        if (state.tables.length === 0) {
            tableList.innerHTML = '<p class="text-gray-400">No tables to manage.</p>';
            return;
        }
        tableList.innerHTML = state.tables.map(table => `
            <a href="#" data-table="${table}" class="block py-2.5 px-4 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700 hover:text-white ${state.currentTable === table ? 'bg-blue-600 text-white' : ''}">
                ${table}
            </a>
        `).join('');
    }

    function renderDataTable() {
        if (!state.currentTable) {
            placeholder.classList.remove('hidden');
            dataTableContainer.classList.add('hidden');
            return;
        }

        if (state.sorting.column) {
            resetSortBtn.classList.remove('hidden');
        } else {
            resetSortBtn.classList.add('hidden');
        }

        placeholder.classList.add('hidden');
        dataTableContainer.classList.remove('hidden');

        const schema = state.schemas[state.currentTable];
        if (!schema) {
            dataTableContainer.innerHTML = '<p>Could not load schema information.</p>';
            return;
        }

        const headers = schema.columns.map(c => c.column_name);

        let tableHTML = `<table class="min-w-full divide-y divide-gray-600 table-fixed">
            <thead class="bg-gray-700">
                <tr>
                    ${headers.map(h => {
                        const isSorting = state.sorting.column === h;
                        const sortIcon = isSorting ? (state.sorting.direction === 'asc' ? '▲' : '▼') : '';
                        return `<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-100 uppercase tracking-wider cursor-pointer" data-column="${h}">
                                    <div class="flex items-center">
                                        <span class="truncate">${h}</span>
                                        <span class="ml-2 w-4 flex-shrink-0 text-center">${sortIcon}</span>
                                    </div>
                                </th>`;
                    }).join('')}
                    <th scope="col" class="relative px-6 py-3 w-32"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700">`;

        if (state.currentData.length === 0) {
            tableHTML += `<tr><td colspan="${headers.length + 1}" class="px-6 py-12 text-center text-gray-400">No data to display.</td></tr>`;
        } else {
            state.currentData.forEach(row => {
                tableHTML += `<tr class="transition duration-150 hover:bg-gray-700">`;
                headers.forEach(header => {
                    const value = row[header];
                    const displayValue = value === null || value === undefined ? '<em class="text-gray-500">null</em>' : String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 truncate">${displayValue}</td>`;
                });
                const rowId = row[schema.primaryKey];
                tableHTML += `
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${rowId}" class="edit-btn text-indigo-400 hover:text-indigo-600">Edit</button>
                        <button data-id="${rowId}" class="delete-btn text-red-400 hover:text-red-600 ml-4">Delete</button>
                    </td>
                `;
                tableHTML += `</tr>`;
            });
        }

        tableHTML += `</tbody></table>`;
        dataTableContainer.innerHTML = tableHTML;
    }

    function openModal(mode, item = null) {
        state.editingItem = item;
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('modal-enter-active'), 10);

        modalTitle.textContent = mode === 'create' ? `New Item in ${state.currentTable}` : `Edit Item in ${state.currentTable}`;

        const schema = state.schemas[state.currentTable];
        modalForm.innerHTML = schema.columns.map(col => {
            const isPrimaryKey = col.is_primary_key;
            const isSerial = col.data_type.includes('serial') || col.data_type.includes('identity');
            if (isSerial && mode === 'create') {
                return '';
            }

            if (isPrimaryKey && mode === 'edit') {
                 return `
                    <div class="mb-4">
                        <label for="${col.column_name}" class="block text-sm font-medium text-gray-400 mb-2">${col.column_name} (Primary Key)</label>
                        <input type="text" name="${col.column_name}" id="${col.column_name}" value="${item ? item[col.column_name] : ''}"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200" readonly>
                    </div>`;
            }

            const value = item && item[col.column_name] !== null ? String(item[col.column_name]).replace(/"/g, "&quot;") : '';
            return `
                <div class="mb-4">
                    <label for="${col.column_name}" class="block text-sm font-medium text-gray-400 mb-2">${col.column_name}</label>
                    <input type="${getInputType(col.data_type)}" name="${col.column_name}" id="${col.column_name}" value="${value}"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200">
                </div>`;
        }).join('');
    }

    function closeModal() {
        modal.classList.remove('modal-enter-active');
        modal.classList.add('modal-leave-active');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('modal-leave-active');
        }, 200);
    }

    function getInputType(dataType) {
        if (['integer', 'bigint', 'smallint', 'numeric', 'decimal', 'real', 'double precision'].some(t => dataType.startsWith(t))) return 'number';
        if (dataType.includes('timestamp')) return 'datetime-local';
        if (dataType === 'date') return 'date';
        if (dataType === 'boolean') return 'checkbox';
        return 'text';
    }

    async function fetchAndRenderData() {
        if (!state.currentTable) return;

        let url = `${API_BASE}/data/${state.currentTable}`;
        const params = new URLSearchParams();
        if (state.sorting.column) {
            params.append('sort_by', state.sorting.column);
            params.append('sort_order', state.sorting.direction);
        }
        
        const queryString = params.toString();
        if (queryString) {
            url += `?${queryString}`;
        }

        try {
            const data = await apiFetch(url);
            state.currentData = data;
            renderDataTable();
        } catch (error) {
             dataTableContainer.innerHTML = `<p class="text-red-400">Error loading data: ${error.message}</p>`;
        }
    }

    async function selectTable(tableName) {
        state.currentTable = tableName;
        currentTableNameEl.textContent = tableName;
        createBtn.classList.remove('hidden');

        state.sorting.column = null;
        state.sorting.direction = 'asc';

        renderTableList();
        await fetchAndRenderData();
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(modalForm);
        let data = Object.fromEntries(formData.entries());

        const schema = state.schemas[state.currentTable];

        schema.columns.forEach(col => {
            const colName = col.column_name;
            if (data[colName] === '' && col.is_nullable === 'YES') {
                data[colName] = null;
            } else if (getInputType(col.data_type) === 'number' && data[colName]) {
                data[colName] = Number(data[colName]);
            }
        });

        const url = state.editingItem
            ? `${API_BASE}/data/${state.currentTable}/${state.editingItem[schema.primaryKey]}`
            : `${API_BASE}/data/${state.currentTable}`;

        const method = state.editingItem ? 'PUT' : 'POST';

        try {
            const result = await apiFetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast(state.editingItem ? 'Data updated successfully.' : 'Data saved successfully.');
            closeModal();
            await fetchAndRenderData();
        } catch (error) {
            console.error('Submit failed:', error);
        }
    }

    async function handleDelete(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        try {
            await apiFetch(`${API_BASE}/data/${state.currentTable}/${itemId}`, { method: 'DELETE' });
            showToast('Data deleted successfully.');
            await fetchAndRenderData();
        } catch (error) {
            console.error('Delete failed:', error);
        }
    }

    tableList.addEventListener('click', e => {
        e.preventDefault();
        const target = e.target.closest('a');
        if (target) {
            const tableName = target.dataset.table;
            if (tableName && tableName !== state.currentTable) selectTable(tableName);
        }
    });

    createBtn.addEventListener('click', () => openModal('create'));
    resetSortBtn.addEventListener('click', () => {
        state.sorting.column = null;
        state.sorting.direction = 'asc';
        fetchAndRenderData();
    });

    modalForm.addEventListener('submit', handleFormSubmit);
    modalCancel.addEventListener('click', closeModal);
    modalSubmit.addEventListener('click', () => modalForm.requestSubmit());

    dataTableContainer.addEventListener('click', e => {
        if (e.target.closest('.edit-btn')) {
            const itemId = e.target.closest('.edit-btn').dataset.id;
            const schema = state.schemas[state.currentTable];
            const item = state.currentData.find(d => String(d[schema.primaryKey]) === String(itemId));
            if (item) openModal('edit', item);
            return;
        }
        if (e.target.closest('.delete-btn')) {
            const itemId = e.target.closest('.delete-btn').dataset.id;
            handleDelete(itemId);
            return;
        }

        const header = e.target.closest('th[data-column]');
        if (header) {
            const column = header.dataset.column;
            if (state.sorting.column === column) {
                state.sorting.direction = state.sorting.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.sorting.column = column;
                state.sorting.direction = 'asc';
            }
            fetchAndRenderData();
        }
    });

    async function init() {
        try {
            const schemaData = await apiFetch(`${API_BASE}/schema`);
            state.tables = schemaData.tables;
            state.schemas = schemaData.schemas;
            renderTableList();
            if (state.tables.length > 0) {
               await selectTable(state.tables[0]);
            } else {
                 placeholder.innerHTML = `<p>No tables to manage. Check your .env file.</p>`;
            }
        } catch (error) {
            placeholder.innerHTML = `<p class="text-red-400">Error during initialization: ${error.message}</p>`;
            tableList.innerHTML = '<p class="text-red-400">Server connection failed</p>';
        }
    }

    init();
});
</script>
</body>
</html>
